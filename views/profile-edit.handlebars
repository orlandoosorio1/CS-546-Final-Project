<main class="profile-edit-container">
    <h1>Edit Your Profile</h1>
    <form action="/profile/edit" method="POST" class="edit-profile-form" onsubmit="return calculateAndSetAge()">
        <label for="dob">Date of Birth:</label>
        <input type="date" id="dob" name="dob" value="{{user.dob}}" required>

        <label for="age">Age:</label>
        <input type="number" id="age" name="age" readonly required>

        <label for="favoritePokemon">Favorite Pok√©mon:</label>
        <input type="text" id="favPokemon" name="favPokemon" value="{{user.favPokemon}}" required>

        <button type="submit">Save Changes</button>
    </form>

    <p id="dobWarning" style="color: red; display: none;">
        The selected Date of Birth is in the future. Please select a valid date.
    </p>
</main>

<script>
    const dobInput = document.getElementById('dob');
    const ageInput = document.getElementById('age');
    const dobWarning = document.getElementById('dobWarning');

    // Function to calculate age
    const calculateAge = (dob) => {
        const today = new Date();
        const birthDate = new Date(dob);

        if (isNaN(birthDate.getTime())) {
            return NaN; 
        }

        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        // Check if the date is in the future
        if (birthDate > today) {
            return 'future';
        }

        return age;
    };

    // Update age dynamically when DOB changes
    dobInput.addEventListener('change', () => {
        const dobValue = dobInput.value;
        const age = calculateAge(dobValue);

        if (age === 'future') {
            dobWarning.style.display = 'block';
            ageInput.value = ''; 
        } else {
            dobWarning.style.display = 'none'; 
            ageInput.value = isNaN(age) ? '' : age; // Set the calculated age
        }
    });

    // Function to calculate and set the age before form submission
    const calculateAndSetAge = () => {
        const dobValue = dobInput.value;
        const age = calculateAge(dobValue);

        if (age === 'future') {
            alert('The selected Date of Birth is in the future. Please select a valid date.');
            return false; // Prevent form submission
        }

        if (!isNaN(age)) {
            ageInput.value = age; // Set the calculated age
        }
        return true; 
    };

    // Automatically calculate age if DOB is pre-filled on page load
    window.addEventListener('DOMContentLoaded', () => {
        if (dobInput.value) {
            const age = calculateAge(dobInput.value);
            if (age === 'future') {
                dobWarning.style.display = 'block';
            } else {
                dobWarning.style.display = 'none';
                ageInput.value = isNaN(age) ? '' : age;
            }
        }
    });
</script>
